from telegram import Update, InlineKeyboardButton, InlineKeyboardMarkup
from telegram.ext import ContextTypes, ConversationHandler
from core.database import Database

# Состояния для ConversationHandler
ENTER_PASSWORD = 0

async def student_menu(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Показывает меню студента"""
    keyboard = [
        [InlineKeyboardButton("Мои уроки", callback_data="student_lessons")],
        [InlineKeyboardButton("Мои заметки", callback_data="student_notes")]
    ]
    reply_markup = InlineKeyboardMarkup(keyboard)
    
    if update.callback_query:
        await update.callback_query.edit_message_text(
            text="Выберите действие:",
            reply_markup=reply_markup
        )
    else:
        await update.message.reply_text(
            text="Выберите действие:",
            reply_markup=reply_markup
        )

async def handle_password(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Обрабатывает ввод пароля"""
    db: Database = context.bot_data['db']
    password = update.message.text
    user_id = update.effective_user.id
    
    # Проверяем пароль
    student = db.get_student_by_password(password)
    if student:
        # Обновляем Telegram ID студента
        db.update_student_telegram_id(student.id, user_id)
        
        # Показываем меню студента
        await student_menu(update, context)
        return ConversationHandler.END
    else:
        await update.message.reply_text(
            "❌ Неверный пароль. Пожалуйста, попробуйте еще раз или введите /cancel для отмены."
        )
        return ENTER_PASSWORD

async def handle_student_actions(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Обрабатывает действия студента"""
    query = update.callback_query
    await query.answer()
    
    if query.data == "student_lessons":
        await query.edit_message_text(text="Здесь будут ваши уроки")
    elif query.data == "student_notes":
        await query.edit_message_text(text="Здесь будут ваши заметки") 